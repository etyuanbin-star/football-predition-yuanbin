import streamlit as st
import pandas as pd

# --- 1. é¡µé¢é…ç½® ---
st.set_page_config(page_title="èƒœç®—å®éªŒå®¤ï¼šç»ˆæé£æ§ç‰ˆ", layout="wide")

st.title("ğŸ”º èƒœç®—å®éªŒå®¤ï¼šå…¨åŠŸèƒ½é£æ§ & é£é™©ç›‘æ§ç³»ç»Ÿ")
st.caption("é›†æˆäº†ï¼šæ¯”åˆ†ç‚¹å¯¹ç‚¹æ ¡éªŒã€å¤å¼æœ¬é‡‘å¹³æ‘Šã€EVé£é™©ç›‘æ§åŠç”Ÿå­˜ç™½çš®ä¹¦")

# --- 2. é€»è¾‘ç™½çš®ä¹¦ (ä½“ç°æ‚¨çš„æ€æƒ³æ ¸å¿ƒ) ---
with st.expander("ğŸ“– èƒœç®—å®éªŒå®¤ï¼šæ ¸å¿ƒç­–ç•¥ç™½çš®ä¹¦", expanded=True):
    st.markdown("""
    ### ğŸ›¡ï¸ æ ¸å¿ƒæ€æƒ³ï¼šç»“æ„åŒ–é£é™©è½¬ç§»ä¸ç”Ÿå­˜åšå¼ˆ
    æœ¬ç³»ç»Ÿå»ºç«‹åœ¨æ‰¿è®¤â€œåº„å®¶ä¼˜åŠ¿â€çš„å‰æä¸‹ï¼Œé€šè¿‡æ•°å­¦æ‰‹æ®µå°†ç›²ç›®åšå¼ˆè½¬åŒ–ä¸ºç†æ€§çš„é£é™©ç®¡ç†ã€‚

    #### **1. ç­–ç•¥ Aï¼šæ¯”åˆ†æµ (ç²¾å‡†é˜²å¾¡)**
    - **é€»è¾‘**ï¼šé’ˆå¯¹ 0-2 çƒåŒºé—´å†…æœ€å¯èƒ½å‡ºç°çš„ 6 ç§æ¯”åˆ†è¿›è¡Œç‚¹å¯¹ç‚¹é˜²å¾¡ã€‚
    - **é£æ§æ ¸å¿ƒ**ï¼šä¸è¿½æ±‚åœ¨å°çƒåŒºç›ˆåˆ©ï¼Œè€Œæ˜¯é€šè¿‡ç²¾å‡†æŠ•å…¥ï¼Œç¡®ä¿å¤§çƒå¤±è´¥æ—¶ï¼Œæœ¬é‡‘èƒ½æœ€å¤§ç¨‹åº¦å›æ”¶ã€‚
    - **ç»“ç®—è¦æ±‚**ï¼šå¿…é¡»è¿›è¡Œç‚¹å¯¹ç‚¹æ ¡éªŒï¼Œæœªè¦†ç›–çš„æ¯”åˆ†å³ä¸ºé£é™©çœŸç©ºåŒºã€‚

    #### **2. ç­–ç•¥ Bï¼šå¤å¼ä¸²å…³æµ (æ æ†ç”Ÿå­˜)**
    - **é€»è¾‘**ï¼šåˆ©ç”¨â€œä½èµ”ç¨³èƒ†â€ä½œä¸ºæ æ†ï¼Œæ‹‰é«˜ 0, 1, 2 çƒå¯¹å†²é¡¹çš„å›æŠ¥ç‡ã€‚
    - **æˆæœ¬æ§åˆ¶**ï¼šæ€»æœ¬é‡‘ = å¤§çƒä¸»æ”»é‡‘é¢ + å¤å¼æ€»æŠ•å…¥é‡‘é¢ã€‚ç³»ç»Ÿè‡ªåŠ¨å¹³æ‘Šå¯¹å†²é‡‘ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

    #### **3. é£é™©ç›‘æ§ï¼šæ‰¿è®¤ç©å®¶æ— æ³•èµ¢è¿‡åº„å®¶**
    - **åšå¼ˆæœ¬è´¨**ï¼šé•¿æœŸåšå¼ˆä¸­ï¼Œç”±äºåº„å®¶æŠ½æ°´çš„å­˜åœ¨ï¼Œç©å®¶æ— æ³•ä»æ¦‚ç‡ä¸Šèµ¢è¿‡åº„å®¶ã€‚
    - **EV æ„ä¹‰**ï¼šè®¡ç®— EV (æœŸæœ›å€¼) ä¸æ˜¯ä¸ºäº†é¢„æµ‹ç›ˆåˆ©ï¼Œè€Œæ˜¯ä¸ºäº†**é‡åŒ–â€œå¤±è¡€é€Ÿåº¦â€**ã€‚
    - **æ ¸å¿ƒè­¦ç¤º**ï¼šå¦‚æœ EV ä¸¥é‡ä¸ºè´Ÿï¼Œè¯´æ˜å¯¹å†²æˆæœ¬å·²ä¸¥é‡ä¾µèš€ç”Ÿå­˜ç©ºé—´ã€‚ç³»ç»Ÿå­˜åœ¨çš„æ„ä¹‰æ˜¯æé†’ç©å®¶ï¼šä¸è¦è¯•å›¾æˆ˜èƒœæ¦‚ç‡ï¼Œè¦åœ¨æ¦‚ç‡çš„æ³¢åŠ¨ä¸­å¯»æ‰¾ç”Ÿå­˜è¾¹ç•Œã€‚
    """)

# --- 3. ä¾§è¾¹æ ï¼šæ ¸å¿ƒæ•°æ®è¾“å…¥ ---
with st.sidebar:
    st.header("âš–ï¸ æ ¸å¿ƒå¤§çƒé¡¹ (O2.5)")
    o25_odds = st.number_input("å¤§çƒ (3çƒ+) èµ”ç‡", value=2.30, step=0.01)
    o25_stake = st.number_input("å¤§çƒæŠ•å…¥é‡‘é¢", value=100.0, step=1.0)
    
    st.divider()
    st.header("ğŸ§  é£é™©è¯„ä¼°å‚æ•°")
    pred_prob = st.slider("ä½ é¢„æµ‹çš„å¤§çƒå‘ç”Ÿæ¦‚ç‡ (%)", 10, 90, 45) / 100
    
    st.divider()
    mode = st.radio("è¯·é€‰æ‹©æ‰§è¡Œç­–ç•¥ï¼š", ["ç­–ç•¥ 1ï¼šæ¯”åˆ†ç²¾å‡†æµ", "ç­–ç•¥ 2ï¼šæ€»è¿›çƒå¤å¼æµ"])

# --- 4. ä¸»è¾“å…¥åŒºï¼šé€»è¾‘é…ç½® ---
st.divider()
col_in, col_out = st.columns([1.6, 2], gap="large")

active_bets = []
# åŠ å…¥æ ¸å¿ƒé¡¹
active_bets.append({"é¡¹ç›®": "3çƒ+", "èµ”ç‡": o25_odds, "é‡‘é¢": o25_stake, "åˆ†ç±»": "ä¸»æ”»"})

with col_in:
    if mode == "ç­–ç•¥ 1ï¼šæ¯”åˆ†ç²¾å‡†æµ":
        st.write("### ğŸ•¹ï¸ è®¾å®šæ¯”åˆ†å¯¹å†² (ç‚¹å¯¹ç‚¹æ ¡éªŒ)")
        st.info("è¯·å‹¾é€‰æ‚¨è¦é˜²å¾¡çš„æ¯”åˆ†ï¼Œå¹¶è¾“å…¥å³æ—¶èµ”ç‡ï¼š")
        scores = ["0-0", "1-0", "0-1", "1-1", "2-0", "0-2"]
        default_odds = {"0-0": 10.0, "1-0": 8.5, "0-1": 8.0, "1-1": 7.0, "2-0": 13.0, "0-2": 12.0}
        
        for s in scores:
            c1, c2, c3 = st.columns([1, 1.2, 1.2])
            with c1: is_on = st.checkbox(s, key=f"s1_{s}")
            with c2: s_amt = st.number_input(f"{s}é‡‘é¢", value=33.0, key=f"s1_am_{s}", label_visibility="collapsed") if is_on else 0.0
            with c3: s_odd = st.number_input(f"{s}èµ”ç‡", value=default_odds[s], key=f"s1_od_{s}", label_visibility="collapsed") if is_on else 0.0
            if is_on: active_bets.append({"é¡¹ç›®": s, "èµ”ç‡": s_odd, "é‡‘é¢": s_amt, "åˆ†ç±»": "å¯¹å†²"})
    
    else:
        st.write("### ğŸ•¹ï¸ è®¾å®šæ€»è¿›çƒå¤å¼å¯¹å†²")
        st.info("ç¨³èƒ†+æ€»è¿›çƒè§†ä¸ºä¸€ç¬”å¤å¼æ³¨å•ã€‚è¾“å…¥æ€»é‡‘é¢ï¼Œç³»ç»Ÿè‡ªåŠ¨å¹³æ‘Šã€‚")
        strong_win = st.number_input("ç¨³èƒ†èµ”ç‡ (å¦‚ 1.35)", value=1.35, step=0.01)
        multi_stake = st.number_input("å¤å¼å¯¹å†²é¡¹æ€»æŠ•å…¥", value=100.0, step=1.0)
        
        st.divider()
        totals = ["0çƒ", "1çƒ", "2çƒ"]
        img_odds = {"0çƒ": 7.20, "1çƒ": 3.55, "2çƒ": 3.00}
        
        selected_items = []
        for g in totals:
            c1, c2 = st.columns([1, 2])
            with c1: is_on = st.checkbox(g, key=f"s2_{g}", value=(g != "0çƒ"))
            with c2: g_odd = st.number_input(f"{g}èµ”ç‡", value=img_odds[g], key=f"s2_od_{g}", label_visibility="collapsed") if is_on else 0.0
            if is_on: selected_items.append({"name": g, "odd": g_odd})
        
        if selected_items:
            share_stake = multi_stake / len(selected_items)
            for item in selected_items:
                active_bets.append({
                    "é¡¹ç›®": item['name'], 
                    "èµ”ç‡": item['odd'] * strong_win, 
                    "é‡‘é¢": share_stake, 
                    "åˆ†ç±»": "å¯¹å†²"
                })

    # è®¡ç®—æ€»æœ¬é‡‘
    total_cost = sum(b['é‡‘é¢'] for b in active_bets)
    st.metric("ğŸ’° æ–¹æ¡ˆå®é™…æ€»æŠ•å…¥ (Total Stake)", f"${total_cost:.2f}")

# --- 5. ç›ˆäºæ¨¡æ‹Ÿä¸ EV ç›‘æ§ ---
with col_out:
    st.write("### ğŸ“Š æ¨¡æ‹Ÿç›ˆäºæ ¡éªŒ (æ ¸å¿ƒç‚¹å¯¹ç‚¹)")
    
    # æ ¸å¿ƒä¿®æ­£ï¼šç­–ç•¥1ä¸‹ç½—åˆ—6ç§æ¯”åˆ†ç»„åˆ
    if mode == "ç­–ç•¥ 1ï¼šæ¯”åˆ†ç²¾å‡†æµ":
        test_outcomes = ["0-0", "1-0", "0-1", "1-1", "2-0", "0-2", "3çƒ+"]
    else:
        test_outcomes = ["0çƒ", "1çƒ", "2çƒ", "3çƒ+"]
    
    res_list = []
    for out in test_outcomes:
        income = 0
        for b in active_bets:
            if b['é¡¹ç›®'] == out:
                income += b['é‡‘é¢'] * b['èµ”ç‡']
        
        res_list.append({"æ¨¡æ‹Ÿèµ›æœ": out, "å‡€ç›ˆäº": round(income - total_cost, 2)})

    df_res = pd.DataFrame(res_list)
    
    # å¯è§†åŒ–å›¾è¡¨
    st.bar_chart(df_res.set_index("æ¨¡æ‹Ÿèµ›æœ")["å‡€ç›ˆäº"])
    
    # ç½—åˆ—è¯¦ç»†ç›ˆäºè¡¨
    st.table(df_res)
    
    # EV ç›‘æ§ä»ªè¡¨
    st.divider()
    st.subheader("âš ï¸ é£é™©ç›‘æ§ä¸ EV é‡åŒ–")
    
    # æ¨¡æ‹Ÿæ¦‚ç‡åˆ†å¸ƒè®¡ç®—
    other_prob = (1 - pred_prob) / (len(test_outcomes) - 1)
    ev = sum(row['å‡€ç›ˆäº'] * (pred_prob if row['æ¨¡æ‹Ÿèµ›æœ'] == "3çƒ+" else other_prob) for _, row in df_res.iterrows())
    
    st.metric("å•åœºé¢„æœŸ EV (é‡åŒ–å¤±è¡€)", f"${ev:.2f}")
    
    if ev < -15:
        st.error("âŒ æé«˜é£é™©ï¼šEV ä¸¥é‡äºæŸã€‚åº„å®¶æ­£åœ¨å¿«é€Ÿåå™¬æœ¬é‡‘ï¼Œè¯·å‰Šå‡å¯¹å†²æ”¯å‡ºã€‚")
    elif ev < 0:
        st.warning("âš ï¸ é£é™©è­¦ç¤ºï¼šEV ä¸ºè´Ÿã€‚å±äºæ­£å¸¸çš„åšå¼ˆæŸè€—ï¼Œè¯·è€ƒè™‘æé«˜ç¨³èƒ†èµ”ç‡ã€‚")
    else:
        st.success("âœ… ç”Ÿå­˜ä»·å€¼ï¼šå½“å‰èµ”ç‡ç»„åˆåœ¨æ•°å­¦ä¸Šå…·å¤‡åšå¼ˆä»·å€¼ã€‚")

st.divider()
# è¦†ç›–ç‡æ˜¾ç¤º
coverage = 0.77 if mode == "ç­–ç•¥ 2ï¼šæ€»è¿›çƒå¤å¼æµ" else 0.73
st.write(f"å½“å‰ç­–ç•¥ç»„åˆç†è®ºå…ˆè§‰è¦†ç›–ç‡: **{coverage:.1%}**")
